# Server development guide

## Prerequisite

You need to install the following:

1. [Docker](https://docs.docker.com/get-docker/)
1. [.NET Core SDK](https://dotnet.microsoft.com/download)

## Running the server locally

Launch Envoy:

```
docker-compose up -d
```

Launch Yngdieng backend server:
```
./run_backend.sh
```

> If you want to test TTS endpoint. Run `bazel build //assets:tts_audio_wav` before starting the backend.

The server will be responding to requests at http://localhost:5000/. (gRPC and gPRC-Web)

Launch the gateway server:

```
bazel run //server/gateway
```

The gateway server will be responding to requests at http://localhost:8081/. (REST)

## Building the Index locally

The index contains all the data needed by the backend server at runtime. It 
is pre-generated by [Indexer](https://github.com/MindongLab/yngdieng/tree/master/server/indexer). The structure of the index is defined [here](https://github.com/MindongLab/yngdieng/blob/ba8fe61e3eabfc24b032e3dc08f2f56dc568f829/shared/documents.proto#L123).

The backend server will refuse to run without an index file. 

1. To build the index, you first need to collect the following files into the "data" directory

  * opencc_data_dictionary -- the `data/dictionary` directory of the [OpenCC](https://github.com/BYVoid/OpenCC) repo
  * `CikLinBekIn.csv` from the [only3km/ciklinbekin](https://github.com/only3km/ciklinbekin/blob/gh-pages/CikLinBekIn.csv) repo
  * `DFDCharacters.csv` from the [only3km/ciklinbekin](https://github.com/only3km/ciklinbekin/blob/gh-pages/DFDCharacters.csv) repo
  * feng.txt -- from the [zingzeu-data](https://github.com/ztl8702/zingzeu-data) repo
  * feng_zeu_mapping.txt -- from the [zingzeu-data](https://github.com/ztl8702/zingzeu-data) repo
  * contrib.tsv -- from the [zingzeu-data](https://github.com/ztl8702/zingzeu-data) repo
  * zingzeu_words.txt -- from the [zingzeu-data](https://github.com/ztl8702/zingzeu-data) repo

1. Start opencc_daemon in one of your terminal windows (词典索引中的简繁模糊查询用)
   ```
   bazel run //server/opencc_daemon
   ```

1. Now run the Indexer in another terminal.
   ```
   dotnet run -p server/indexer/Yngdieng.Indexer.csproj -- ../../data ../../output
   ```

   > For V2 Index, use:
   > ```
   > dotnet run -p server/indexer/Yngdieng.Indexer.csproj -- ../../data ../../output notag v2
   > ```

You should see the generated index file in the `output` directory.
